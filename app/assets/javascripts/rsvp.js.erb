$(document).ready(function() {

  $('#search').on("input", function(e){
    e.preventDefault();
    e.stopPropagation();
    var url = '/rsvps';
    var q = $('#search').serialize()
    $.get(url, q, function(html) {
      $('.rsvps').replaceWith(html)
    })
  });

  $('html').on('click', '.ticket', function(e){
    if (this.classList.contains("ticket-checked")) {
      e.preventDefault();
      e.stopPropagation();
      var id = $(this).data('id');
      checkOut(id);
    } else {
      e.preventDefault();
      e.stopPropagation();
      var id = $(this).data('id');
      checkIn(id);
    }
  });

  $('html').on('click', '.checkin', function(e){
    e.preventDefault();
    e.stopPropagation();
    var id = $(this).data('id');
    checkIn(id);
  });

  $('html').on('click', '.checkout', function(e){
    e.preventDefault();
    e.stopPropagation();
    var id = $(this).data('id');
    checkOut(id);
  });

  $('body').on('click', '.refresh', function(e){
    e.preventDefault();
    e.stopPropagation();
    var sidebarHtml = loadingIn();
    var url = '/sync';
    $.get(url, function(html) {
      $('#rsvp-results').html(html)
      loadingOut(sidebarHtml);
    });
  });

  $('.container').on('click', '.rsvp-click-zone', function(e){
    e.preventDefault();
    e.stopPropagation();
    var url = this.attributes.href.value
    $.get(url, function(html) {
      $('.show-card-content').html(html)
      showCard();
      $('.rsvp-name').removeClass("black");
      $('a[href="' + url + '"]').addClass("black");
    });
  });

  $('.container').on('click', '.guests a', function(e){
    e.preventDefault();
    e.stopPropagation();
    if (this.classList.contains("new-ticket")) {
      var url = this.attributes.href.value
      $.get(url, function(html) {
        $('.show-card-content').html(html)
        showCard();
      });
    } else {
      var url = this.attributes.href.value
      $.get(url, function(html) {
        $('.show-card-content').html(html)
        showCard();
      });
    }
  });

  $('.add-rsvp a').on('click', function(e){
    e.preventDefault();
    e.stopPropagation();
    var url = this.attributes.href.value
    var page = "newRsvp"
    $.get(url, function(html) {
      $('.show-card-content').html(html)
      updateIcons(page);
      showCard();
    });
  });

  $('.settings a').on('click', function(e){
    e.preventDefault();
    e.stopPropagation();
    var page = "settings"
    var url = this.attributes.href.value
    if (window.location.href.includes("/rsvps")) {
      $.get(url, function(html) {
        $('.show-card-content').html(html)
        updateIcons(page);
        showCard();
      });
    } else if (window.location.href.includes("/landing")) {
      $.get(url, function(html) {
        $('.main').html("<div class='container'></div>");
        $('.main .container').html(html);
        updateIcons(page);
      });
    }
  });

  $('.container').on('click', '.show-card-close', function(e){
    hideCard();
  });

  $('body').on('click', '.check-in', function(e){
    e.preventDefault();
    e.stopPropagation();
    var page = "checkIn"
    updateIcons(page);
    hideCard();
  });

  function checkIn(id){
    $('*[id*=load-ani-'+id+']').each(function() {
        $(this).show()
    });
    var url = '/rsvps/check_in';
    $.ajax({
      type: "POST",
      url: url,
      dataType: 'script',
      data: {
          'id': id,
          'attended': true
        }
    });
  }

  function checkOut(id){
    $('*[id*=load-ani-'+id+']').each(function() {
        $(this).show()
    });
    var url = '/rsvps/check_out';
    $.ajax({
      type: "POST",
      url: url,
      dataType: 'script',
      data: {
          'id': id,
          'attended': false
        }
    });
  }

  function updateIcons(page) {

    $.each($('.icons a h6'), function(key, value){
      $(value).css("color", "#7c7c7c")
    });

    $.each($('.icons a img'), function(key, value){
      if ($(value).attr("src").includes("Checkmark")) {
        var newSrc = "<%= asset_path("Icon/Checkmark/Grey.svg") %>"
      } else if ($(value).attr("src").includes("Add")) {
        var newSrc = "<%= asset_path("Icon/Add/Grey.svg") %>"
      } else if ($(value).attr("src").includes("Gear")) {
        var newSrc = "<%= asset_path("Icon/Gear/Grey.svg") %>"
      }
      $(value).attr("src", newSrc)
    });

    if (page === "settings") {
      $('.settings a h6').css("color", "#0AC4F8")
      $('.settings a img').attr("src", "<%= asset_path("Icon/Gear/Color.svg") %>")
    } else if (page === "newRsvp") {
      $('.add-rsvp a h6').css("color", "#0AC4F8")
      $('.add-rsvp a img').attr("src", "<%= asset_path("Icon/Add/Color.svg") %>")
    } else if (page === "checkIn") {
      $('.check-in a h6').css("color", "#0AC4F8")
      $('.check-in a img').attr("src", "<%= asset_path("Icon/Checkmark/Color.svg") %>")
    } else {};
  };

  function hideCard() {
    $('.show-card').hide();
    $('.rsvp-name').removeClass("black");
    $('body').removeClass("overflow-hidden");
  }

  function showCard() {
    $('.show-card').show();
    $('body').addClass("overflow-hidden");
    if (window.innerWidth > 792) {
      $("html, body").animate({ scrollTop: 0 }, "slow");
    }
  };
})
